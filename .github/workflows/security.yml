name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Monday at 6 AM UTC
    - cron: '0 6 * * 1'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Vulnerability scanning with cargo-audit
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Checkout hpc-channels dependency
        uses: actions/checkout@v4
        with:
          repository: rustyhpc/hpc-channels
          path: hpc-channels

      - name: Checkout rmpi dependency
        uses: actions/checkout@v4
        with:
          repository: rustyhpc/rmpi
          path: rmpi

      - name: Checkout slai dependency
        uses: actions/checkout@v4
        with:
          repository: rustyhpc/slai
          path: slai

      - name: Create symlinks for path dependencies
        run: |
          ln -s $GITHUB_WORKSPACE/hpc-channels $GITHUB_WORKSPACE/../hpc-channels
          ln -s $GITHUB_WORKSPACE/rmpi $GITHUB_WORKSPACE/../rmpi
          ln -s $GITHUB_WORKSPACE/slai $GITHUB_WORKSPACE/../slai

      - uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

  # Dependency policy with cargo-deny
  deny:
    name: Dependency Policy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Checkout hpc-channels dependency
        uses: actions/checkout@v4
        with:
          repository: rustyhpc/hpc-channels
          path: hpc-channels

      - name: Checkout rmpi dependency
        uses: actions/checkout@v4
        with:
          repository: rustyhpc/rmpi
          path: rmpi

      - name: Checkout slai dependency
        uses: actions/checkout@v4
        with:
          repository: rustyhpc/slai
          path: slai

      - name: Create symlinks for path dependencies
        run: |
          ln -s $GITHUB_WORKSPACE/hpc-channels $GITHUB_WORKSPACE/../hpc-channels
          ln -s $GITHUB_WORKSPACE/rmpi $GITHUB_WORKSPACE/../rmpi
          ln -s $GITHUB_WORKSPACE/slai $GITHUB_WORKSPACE/../slai

      - uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deny
        run: cargo install cargo-deny

      - name: Check advisories
        run: cargo deny check advisories
        continue-on-error: true

      - name: Check licenses
        run: cargo deny check licenses
        continue-on-error: true

      - name: Check bans
        run: cargo deny check bans
        continue-on-error: true

  # Cryptography-specific security checks
  crypto-audit:
    name: Cryptography Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Checkout hpc-channels dependency
        uses: actions/checkout@v4
        with:
          repository: rustyhpc/hpc-channels
          path: hpc-channels

      - name: Checkout rmpi dependency
        uses: actions/checkout@v4
        with:
          repository: rustyhpc/rmpi
          path: rmpi

      - name: Checkout slai dependency
        uses: actions/checkout@v4
        with:
          repository: rustyhpc/slai
          path: slai

      - name: Create symlinks for path dependencies
        run: |
          ln -s $GITHUB_WORKSPACE/hpc-channels $GITHUB_WORKSPACE/../hpc-channels
          ln -s $GITHUB_WORKSPACE/rmpi $GITHUB_WORKSPACE/../rmpi
          ln -s $GITHUB_WORKSPACE/slai $GITHUB_WORKSPACE/../slai

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@v2

      - name: Audit crypto crates
        run: |
          echo "## Cryptography Crate Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for unsafe in crypto crates
          for crate in warp-crypto warp-ec warp-oprf warp-kms; do
            unsafe_count=$(grep -r "unsafe" crates/$crate/src/*.rs 2>/dev/null | wc -l || echo 0)
            echo "| $crate | $unsafe_count unsafe blocks |" >> $GITHUB_STEP_SUMMARY
          done

      - name: Clippy security lints for crypto
        run: |
          cargo clippy -p warp-crypto -p warp-ec -p warp-oprf -p warp-kms -- \
            -W clippy::unwrap_used \
            -W clippy::expect_used \
            -W clippy::panic
        continue-on-error: true

  # Summary report
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [audit, deny, crypto-audit]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| cargo-audit | ${{ needs.audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| cargo-deny | ${{ needs.deny.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| crypto-audit | ${{ needs.crypto-audit.result }} |" >> $GITHUB_STEP_SUMMARY
